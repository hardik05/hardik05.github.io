name: Deploy Unique Training Page

on:
  repository_dispatch:
    types: [license_purchased]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v4

      - name: Mask Sensitive Data
        run: |
          PAYMENT_ID=$(jq -r '.client_payload.payment_id' $GITHUB_EVENT_PATH)
          LICENSE_KEY=$(jq -r '.client_payload.license_key' $GITHUB_EVENT_PATH)
          echo "::add-mask::$PAYMENT_ID"
          echo "::add-mask::$LICENSE_KEY"

      - name: Checkout Private Source Repo
        uses: actions/checkout@v4
        with:
          repository: hardik05/fuzzing-source
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: private-source

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Encrypt Training Page
        env:
          SALT: ${{ secrets.TRAINING_FILENAME_SALT }}
        run: |
          # The payment ID comes from the webhook payload
          PAYMENT_ID=$(jq -r '.client_payload.payment_id' $GITHUB_EVENT_PATH)
          
          # Ensure output directory exists
          mkdir -p codelabs/Practical_Fuzzing/access
          
          # Fix relative paths by replacing them in the source before encryption
          sed -e 's|href="../../|href="../../../|g' \
              -e 's|src="../../|src="../../../|g' \
              -e "s|href='../../|href='../../../|g" \
              -e "s|src='../../|src='../../../|g" \
              -e 's|src="img/|src="../img/|g' \
              -e 's|href="img/|href="../img/|g' \
              -e "s|src='img/|src='../img/|g" \
              -e "s|href='img/|href='../img/|g" \
              private-source/index.html > private-source/index_fixed.html
          
          # Run Staticrypt (v3 uses -d for directory and doesn't have -o for filename)
          npx staticrypt private-source/index_fixed.html -p "$PAYMENT_ID" -d codelabs/Practical_Fuzzing/access --short -c false
          
          # Generate a deterministic but non-obvious filename from the payment ID
          # We use SHA256 with a salt to ensure the filename doesn't reveal the password
          # and is resistant to precomputed rainbow tables.
          if [ -z "$SALT" ]; then
            echo "Error: TRAINING_FILENAME_SALT secret is not set."
            exit 1
          fi
          FILENAME=$(echo -n "${PAYMENT_ID}${SALT}" | sha256sum | awk '{print $1}')
          
          # Rename the output file to the hashed filename
          mv codelabs/Practical_Fuzzing/access/index_fixed.html "codelabs/Practical_Fuzzing/access/$FILENAME.html"

      - name: Commit and Push
        run: |
          git config --global user.name "Fuzzing-in Bot"
          git config --global user.email "bot@fuzzing.in"
          git add codelabs/Practical_Fuzzing/access/
          git commit -m "Add encrypted training access page"
          git push
