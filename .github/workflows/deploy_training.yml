name: Deploy Unique Training Page

on:
  repository_dispatch:
    types: [license_purchased]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Public Repo
        uses: actions/checkout@v4

      - name: Mask Sensitive Data
        run: |
          PAYMENT_ID=$(jq -r '.client_payload.payment_id' $GITHUB_EVENT_PATH)
          LICENSE_KEY=$(jq -r '.client_payload.license_key' $GITHUB_EVENT_PATH)
          echo "::add-mask::$PAYMENT_ID"
          echo "::add-mask::$LICENSE_KEY"

      - name: Checkout Private Source Repo
        uses: actions/checkout@v4
        with:
          repository: hardik05/fuzzing-source
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}
          path: private-source

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine Course from Payment Amount
        env:
          RAZORPAY_KEY_ID: ${{ secrets.RAZORPAY_KEY_ID }}
          RAZORPAY_KEY_SECRET: ${{ secrets.RAZORPAY_KEY_SECRET }}
        run: |
          PAYMENT_ID=$(jq -r '.client_payload.payment_id' $GITHUB_EVENT_PATH)
          PAYLOAD_AMOUNT=$(jq -r '.client_payload.amount // empty' $GITHUB_EVENT_PATH)
          
          # Initialize AMOUNT with payload amount if available
          AMOUNT=$PAYLOAD_AMOUNT

          # If amount not in payload and PAYMENT_ID looks like a payment ID (pay_...), fetch from API
          if [ -z "$AMOUNT" ] && [[ $PAYMENT_ID == pay_* ]]; then
            echo "Fetching payment details from Razorpay API for $PAYMENT_ID..."
            RESPONSE=$(curl -s -u "${RAZORPAY_KEY_ID}:${RAZORPAY_KEY_SECRET}" \
              "https://api.razorpay.com/v1/payments/${PAYMENT_ID}")
            AMOUNT=$(echo $RESPONSE | jq -r '.amount // empty')
          fi
          
          echo "Payment/Order ID: $PAYMENT_ID"
          echo "Detected Amount: $AMOUNT"
          
          # Determine Course ID based on Amount
          # 799900 paise = ₹7,999 -> Mastering Linux Fuzzing
          # 1499900 paise = ₹14,999 -> Practical Fuzzing
          
          if [ "$AMOUNT" == "799900" ] || [ "$AMOUNT" == "7999" ]; then
            echo "Detected Course: Mastering Linux Fuzzing"
            echo "COURSE_ID=mastering_linux" >> $GITHUB_ENV
          elif [ "$AMOUNT" == "1499900" ] || [ "$AMOUNT" == "14999" ]; then
            echo "Detected Course: Practical Fuzzing"
            echo "COURSE_ID=practical_fuzzing" >> $GITHUB_ENV
          else
            # Fallback to payload or default if amount doesn't match known prices
            PAYLOAD_COURSE=$(jq -r '.client_payload.course_id // "practical_fuzzing"' $GITHUB_EVENT_PATH)
            echo "Amount $AMOUNT did not match known courses. Falling back to payload/default: $PAYLOAD_COURSE"
            echo "COURSE_ID=$PAYLOAD_COURSE" >> $GITHUB_ENV
          fi

      - name: Encrypt Training Page
        env:
          SALT: ${{ secrets.TRAINING_FILENAME_SALT }}
        run: |
          # The payment ID comes from the webhook payload
          PAYMENT_ID=$(jq -r '.client_payload.payment_id' $GITHUB_EVENT_PATH)
          # COURSE_ID is now set in the previous step
          
          echo "Processing course: $COURSE_ID"

          if [ "$COURSE_ID" == "mastering_linux" ]; then
            OUTPUT_DIR="codelabs/Mastering_fuzzing_TyphoonCon23/access"
            # TODO: Verify the correct path in private-source repo for this course
            SOURCE_FILE="private-source/mastering/index.html" 
            if [ ! -f "$SOURCE_FILE" ]; then
                echo "Warning: Source file $SOURCE_FILE not found. Checking root index..."
                if [ -f "private-source/index.html" ]; then
                    echo "Using private-source/index.html as fallback."
                    SOURCE_FILE="private-source/index.html"
                else
                    echo "Error: No source file found."
                    exit 1
                fi
            fi
          else
            OUTPUT_DIR="codelabs/Practical_Fuzzing/access"
            SOURCE_FILE="private-source/index.html"
          fi
          
          # Ensure output directory exists
          mkdir -p "$OUTPUT_DIR"
          
          # Fix relative paths by replacing them in the source before encryption
          # Note: Both courses are at codelabs/COURSE_NAME/access, so depth is same (../../../)
          sed -e 's|href="../../|href="../../../|g' \
              -e 's|src="../../|src="../../../|g' \
              -e "s|href='../../|href='../../../|g" \
              -e "s|src='../../|src='../../../|g" \
              -e 's|src="img/|src="../img/|g' \
              -e 's|href="img/|href="../img/|g' \
              -e "s|src='img/|src='../img/|g" \
              -e "s|href='img/|href='../img/|g" \
              "$SOURCE_FILE" > private-source/index_fixed.html
          
          # Run Staticrypt (v3 uses -d for directory and doesn't have -o for filename)
          npx staticrypt private-source/index_fixed.html -p "$PAYMENT_ID" -d "$OUTPUT_DIR" --short -c false
          
          # Generate a deterministic but non-obvious filename from the payment ID
          # We use SHA256 with a salt to ensure the filename doesn't reveal the password
          # and is resistant to precomputed rainbow tables.
          if [ -z "$SALT" ]; then
            echo "Error: TRAINING_FILENAME_SALT secret is not set."
            exit 1
          fi
          FILENAME=$(echo -n "${PAYMENT_ID}${SALT}" | sha256sum | awk '{print $1}')
          
          # Rename the output file to the hashed filename
          mv "$OUTPUT_DIR/index_fixed.html" "$OUTPUT_DIR/$FILENAME.html"

      - name: Commit and Push
        run: |
          git config --global user.name "Fuzzing-in Bot"
          git config --global user.email "bot@fuzzing.in"
          git add codelabs/
          git commit -m "Add encrypted training access page"
          git push
