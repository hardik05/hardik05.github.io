<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CVE-2013-1493 analysis. | Fuzzing.in</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-82JZEHCFPE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-82JZEHCFPE');
    </script>
    <meta name="description" content="I have recived the sample from a friend of mine. some of them are highly obfuscated and some are not. when i tested them with my latest java version, they were ...">
    <meta name="keywords" content="">
    <meta name="author" content="Hardik Shah">
    <link rel="canonical" href="https://fuzzing.in/blog/cve-2013-1493-analysis.html">
    
    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="CVE-2013-1493 analysis. | Fuzzing.in">
    <meta property="og:description" content="I have recived the sample from a friend of mine. some of them are highly obfuscated and some are not. when i tested them with my latest java version, they were ...">
    <meta property="og:image" content="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_50-mar-21-23-34.jpg?w=300">
    <meta property="og:url" content="https://fuzzing.in/blog/cve-2013-1493-analysis.html">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="CVE-2013-1493 analysis. | Fuzzing.in">
    <meta property="twitter:description" content="I have recived the sample from a friend of mine. some of them are highly obfuscated and some are not. when i tested them with my latest java version, they were ...">
    <meta property="twitter:image" content="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_50-mar-21-23-34.jpg?w=300">

    <link rel="icon" href="../images/logo.jpg" type="image/jpeg">
    
    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        };
    </script>
    <script src="../js/nav.js" defer></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for code blocks */
        pre::-webkit-scrollbar { height: 8px; }
        pre::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
        pre::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 4px; }
    </style>
</head>
<body class="py-4 md:py-10 px-2 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Header (Paths adjusted with ../ for subdirectory) -->
    <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800 transition-colors duration-300"></header>

    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Breadcrumb / Back Link -->
        <div class="mb-8">
            <a href="../blog.html" class="text-blue-500 hover:text-blue-400 font-semibold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back to Blog
            </a>
        </div>

        <!-- Article Header -->
        <header class="mb-10 text-center md:text-left">
            <span class="inline-block px-3 py-1 bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 rounded-full text-xs font-bold uppercase tracking-widest mb-4">
                0 day analysis
            </span>
            <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-6 leading-tight">
                CVE-2013-1493 analysis.
            </h1>
            <div class="flex flex-wrap items-center gap-6 text-gray-500 dark:text-gray-400 text-sm">
                <div class="flex items-center gap-2">
                    <img src="../images/hardik.webp" alt="Author" class="w-8 h-8 rounded-full border border-gray-300 dark:border-gray-600 object-cover">
                    <span class="font-medium text-gray-900 dark:text-gray-200">Hardik Shah</span>
                </div>
                <span class="hidden md:inline">•</span>
                <div class="flex items-center gap-2">
                    <i class="far fa-calendar-alt"></i>
                    <span>March 21, 2013</span>
                </div>
                <span class="hidden md:inline">•</span>
                <div class="flex items-center gap-2">
                    <i class="far fa-clock"></i>
                    <span>58 min read</span>
                </div>
                
                <!-- Share Buttons -->
                <div class="flex items-center gap-3 md:ml-auto">
                    <a href="#" id="share-twitter" target="_blank" class="text-gray-500 hover:text-blue-400 transition text-lg" title="Share on Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" id="share-linkedin" target="_blank" class="text-gray-500 hover:text-blue-700 transition text-lg" title="Share on LinkedIn">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="#" id="share-facebook" target="_blank" class="text-gray-500 hover:text-blue-600 transition text-lg" title="Share on Facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="#" id="share-email" class="text-gray-500 hover:text-red-500 transition text-lg" title="Share via Email">
                        <i class="fas fa-envelope"></i>
                    </a>
                    <button id="copy-link-btn" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition text-lg" title="Copy Link">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Featured Image (Optional) -->
        <div class="mb-10 rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
            <!-- FEATURED_IMAGE_START -->
<img src="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_50-mar-21-23-34.jpg?w=300" alt="CVE-2013-1493 analysis." class="w-full h-full object-cover">
<!-- FEATURED_IMAGE_END -->
        </div>

        <!-- Table of Contents -->
        <div id="toc" class="hidden mb-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Table of Contents</h3>
            <nav>
                <ul id="toc-list" class="space-y-2 text-sm text-gray-600 dark:text-gray-300"></ul>
            </nav>
        </div>

        <!-- Article Content -->
        <!-- 'prose' class activates Tailwind Typography plugin -->
        <article class="prose prose-lg prose-slate dark:prose-invert max-w-none">
            <!-- CONTENT_START -->
I have recived the sample from a friend of mine. some of them are highly obfuscated and some are not. when i tested them with my latest java version, they were causing jvm to crash. so i decided to digg further. first thing i did was decompiled the jar file and modified the code to print debug statments so that i can trace out and understand the code while debugging. then i removed uncessessary code and compiled and ran the code in eclipse. then i see following:

<a href="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_50-mar-21-23-34.jpg"><img class="alignnone size-medium wp-image-74" alt="ScreenHunter_50 Mar. 21 23.34" src="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_50-mar-21-23-34.jpg?w=300" width="300" height="88" /></a>

on further debugging i come to know that this is crashing in icctransform.colorconvert function. if you check the code you can see that this function is defined here:

<a href="http://docs.oracle.com/javase/1.5.0/docs/api/java/awt/image/ColorConvertOp.html">http://docs.oracle.com/javase/1.5.0/docs/api/java/awt/image/ColorConvertOp.html</a>

"This class performs a pixel-by-pixel color conversion of the data in the source image. The resulting color values are scaled to the precision of the destination image. Color conversion can be specified via an array of ColorSpace objects or an array of ICC_Profile objects.

If the source is a BufferedImage with premultiplied alpha, the color components are divided by the alpha component before color conversion. If the destination is a BufferedImage with premultiplied alpha, the color components are multiplied by the alpha component after conversion. Rasters are treated as having no alpha channel, i.e. all bands are color bands.

If a RenderingHints object is specified in the constructor, the color rendering hint and the dithering hint may be used to control color conversion.

Note that Source and Destination may be the same object."

it was crashing on making following call from the jar file:

<a href="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_51-mar-21-23-39.jpg"><img class="alignnone size-medium wp-image-75" alt="ScreenHunter_51 Mar. 21 23.39" src="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_51-mar-21-23-39.jpg?w=300" width="300" height="208" /></a>

so there might be some kind of overflow. when i attached debugger, i see that its crashing inside cmm.dll .

if we check the code there are some values which are more then integer.MAX size:

<a href="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_52-mar-21-23-40.jpg"><img class="alignnone size-medium wp-image-76" alt="ScreenHunter_52 Mar. 21 23.40" src="http://hardik05.wordpress.com/wp-content/uploads/2013/03/screenhunter_52-mar-21-23-40.jpg?w=300" width="300" height="87" /></a>

if you check in the above image, doffsets has a very large value which is 50000000.

This can be confirmed from the patch from open jdk from url:

<a href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473">http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473</a>
<div>line diff</div>
<div>
<pre><a id="l1.1" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.1">     1.1</a> --- a/src/share/classes/sun/java2d/cmm/lcms/LCMSImageLayout.java	Thu Feb 14 19:51:51 2013 +0400
<a id="l1.2" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.2">     1.2</a> +++ b/src/share/classes/sun/java2d/cmm/lcms/LCMSImageLayout.java	Thu Feb 21 11:25:43 2013 +0400
<a id="l1.3" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.3">     1.3</a> @@ -99,50 +99,75 @@
<a id="l1.4" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.4">     1.4</a>      int offset;
<a id="l1.5" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.5">     1.5</a>  
<a id="l1.6" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.6">     1.6</a>      Object dataArray;
<a id="l1.7" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.7">     1.7</a> -    private LCMSImageLayout(int np, int pixelType, int pixelSize) {
<a id="l1.8" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.8">     1.8</a> +    private int dataArrayLength; /* in bytes */
<a id="l1.9" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.9">     1.9</a> +
<a id="l1.10" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.10">    1.10</a> +    private LCMSImageLayout(int np, int pixelType, int pixelSize)
<a id="l1.11" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.11">    1.11</a> +            throws ImageLayoutException
<a id="l1.12" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.12">    1.12</a> +    {
<a id="l1.13" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.13">    1.13</a>          this.pixelType = pixelType;
<a id="l1.14" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.14">    1.14</a>          width = np;
<a id="l1.15" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.15">    1.15</a>          height = 1;
<a id="l1.16" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.16">    1.16</a> -        nextRowOffset = np*pixelSize;
<a id="l1.17" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.17">    1.17</a> +        nextRowOffset = safeMult(pixelSize, np);
<a id="l1.18" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.18">    1.18</a>          offset = 0;
<a id="l1.19" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.19">    1.19</a>      }
<a id="l1.20" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.20">    1.20</a>  
<a id="l1.21" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.21">    1.21</a>      private LCMSImageLayout(int width, int height, int pixelType,
<a id="l1.22" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.22">    1.22</a> -                            int pixelSize) {
<a id="l1.23" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.23">    1.23</a> +                            int pixelSize)
<a id="l1.24" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.24">    1.24</a> +            throws ImageLayoutException
<a id="l1.25" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.25">    1.25</a> +    {
<a id="l1.26" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.26">    1.26</a>          this.pixelType = pixelType;
<a id="l1.27" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.27">    1.27</a>          this.width = width;
<a id="l1.28" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.28">    1.28</a>          this.height = height;
<a id="l1.29" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.29">    1.29</a> -        nextRowOffset = width*pixelSize;
<a id="l1.30" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.30">    1.30</a> +        nextRowOffset = safeMult(pixelSize, width);
<a id="l1.31" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.31">    1.31</a>          offset = 0;
<a id="l1.32" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.32">    1.32</a>      }
<a id="l1.33" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.33">    1.33</a>  
<a id="l1.34" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.34">    1.34</a>  
<a id="l1.35" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.35">    1.35</a> -    public LCMSImageLayout(byte[] data, int np, int pixelType, int pixelSize) {
<a id="l1.36" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.36">    1.36</a> +    public LCMSImageLayout(byte[] data, int np, int pixelType, int pixelSize)
<a id="l1.37" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.37">    1.37</a> +            throws ImageLayoutException
<a id="l1.38" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.38">    1.38</a> +    {
<a id="l1.39" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.39">    1.39</a>          this(np, pixelType, pixelSize);
<a id="l1.40" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.40">    1.40</a>          dataType = DT_BYTE;
<a id="l1.41" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.41">    1.41</a>          dataArray = data;
<a id="l1.42" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.42">    1.42</a> +        dataArrayLength = data.length;
<a id="l1.43" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.43">    1.43</a> +
<a id="l1.44" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.44">    1.44</a> +        verify();
<a id="l1.45" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.45">    1.45</a>      }
<a id="l1.46" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.46">    1.46</a>  
<a id="l1.47" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.47">    1.47</a> -    public LCMSImageLayout(short[] data, int np, int pixelType, int pixelSize) {
<a id="l1.48" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.48">    1.48</a> +    public LCMSImageLayout(short[] data, int np, int pixelType, int pixelSize)
<a id="l1.49" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.49">    1.49</a> +            throws ImageLayoutException
<a id="l1.50" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.50">    1.50</a> +    {
<a id="l1.51" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.51">    1.51</a>          this(np, pixelType, pixelSize);
<a id="l1.52" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.52">    1.52</a>          dataType = DT_SHORT;
<a id="l1.53" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.53">    1.53</a>          dataArray = data;
<a id="l1.54" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.54">    1.54</a> +        dataArrayLength = 2 * data.length;
<a id="l1.55" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.55">    1.55</a> +
<a id="l1.56" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.56">    1.56</a> +        verify();
<a id="l1.57" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.57">    1.57</a>      }
<a id="l1.58" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.58">    1.58</a>  
<a id="l1.59" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.59">    1.59</a> -    public LCMSImageLayout(int[] data, int np, int pixelType, int pixelSize) {
<a id="l1.60" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.60">    1.60</a> +    public LCMSImageLayout(int[] data, int np, int pixelType, int pixelSize)
<a id="l1.61" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.61">    1.61</a> +            throws ImageLayoutException
<a id="l1.62" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.62">    1.62</a> +    {
<a id="l1.63" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.63">    1.63</a>          this(np, pixelType, pixelSize);
<a id="l1.64" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.64">    1.64</a>          dataType = DT_INT;
<a id="l1.65" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.65">    1.65</a>          dataArray = data;
<a id="l1.66" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.66">    1.66</a> +        dataArrayLength = 4 * data.length;
<a id="l1.67" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.67">    1.67</a> +
<a id="l1.68" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.68">    1.68</a> +        verify();
<a id="l1.69" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.69">    1.69</a>      }
<a id="l1.70" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.70">    1.70</a>  
<a id="l1.71" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.71">    1.71</a>      public LCMSImageLayout(double[] data, int np, int pixelType, int pixelSize)
<a id="l1.72" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.72">    1.72</a> +            throws ImageLayoutException
<a id="l1.73" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.73">    1.73</a>      {
<a id="l1.74" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.74">    1.74</a>          this(np, pixelType, pixelSize);
<a id="l1.75" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.75">    1.75</a>          dataType = DT_DOUBLE;
<a id="l1.76" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.76">    1.76</a>          dataArray = data;
<a id="l1.77" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.77">    1.77</a> +        dataArrayLength = 8 * data.length;
<a id="l1.78" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.78">    1.78</a> +
<a id="l1.79" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.79">    1.79</a> +        verify();
<a id="l1.80" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.80">    1.80</a>      }
<a id="l1.81" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.81">    1.81</a>  
<a id="l1.82" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.82">    1.82</a> -    public LCMSImageLayout(BufferedImage image) {
<a id="l1.83" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.83">    1.83</a> +    public LCMSImageLayout(BufferedImage image) throws ImageLayoutException {
<a id="l1.84" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.84">    1.84</a>          ShortComponentRaster shortRaster;
<a id="l1.85" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.85">    1.85</a>          IntegerComponentRaster intRaster;
<a id="l1.86" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.86">    1.86</a>          ByteComponentRaster byteRaster;
<a id="l1.87" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.87">    1.87</a> @@ -186,9 +211,13 @@
<a id="l1.88" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.88">    1.88</a>              case BufferedImage.TYPE_INT_ARGB:
<a id="l1.89" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.89">    1.89</a>              case BufferedImage.TYPE_INT_BGR:
<a id="l1.90" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.90">    1.90</a>                  intRaster = (IntegerComponentRaster)image.getRaster();
<a id="l1.91" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.91">    1.91</a> -                nextRowOffset = intRaster.getScanlineStride()*4;
<a id="l1.92" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.92">    1.92</a> -                offset = intRaster.getDataOffset(0)*4;
<a id="l1.93" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.93">    1.93</a> +
<a id="l1.94" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.94">    1.94</a> +                nextRowOffset = safeMult(4, intRaster.getScanlineStride());
<a id="l1.95" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.95">    1.95</a> +
<a id="l1.96" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.96">    1.96</a> +                offset = safeMult(4, intRaster.getDataOffset(0));
<a id="l1.97" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.97">    1.97</a> +
<a id="l1.98" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.98">    1.98</a>                  dataArray = intRaster.getDataStorage();
<a id="l1.99" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.99">    1.99</a> +                dataArrayLength = 4 * intRaster.getDataStorage().length;
<a id="l1.100" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.100">   1.100</a>                  dataType = DT_INT;
<a id="l1.101" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.101">   1.101</a>                  break;
<a id="l1.102" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.102">   1.102</a>  
<a id="l1.103" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.103">   1.103</a> @@ -196,8 +225,10 @@
<a id="l1.104" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.104">   1.104</a>              case BufferedImage.TYPE_4BYTE_ABGR:
<a id="l1.105" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.105">   1.105</a>                  byteRaster = (ByteComponentRaster)image.getRaster();
<a id="l1.106" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.106">   1.106</a>                  nextRowOffset = byteRaster.getScanlineStride();
<a id="l1.107" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.107">   1.107</a> -                offset = byteRaster.getDataOffset(0);
<a id="l1.108" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.108">   1.108</a> +                int firstBand = image.getSampleModel().getNumBands() - 1;
<a id="l1.109" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.109">   1.109</a> +                offset = byteRaster.getDataOffset(firstBand);
<a id="l1.110" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.110">   1.110</a>                  dataArray = byteRaster.getDataStorage();
<a id="l1.111" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.111">   1.111</a> +                dataArrayLength = byteRaster.getDataStorage().length;
<a id="l1.112" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.112">   1.112</a>                  dataType = DT_BYTE;
<a id="l1.113" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.113">   1.113</a>                  break;
<a id="l1.114" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.114">   1.114</a>  
<a id="l1.115" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.115">   1.115</a> @@ -206,17 +237,20 @@
<a id="l1.116" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.116">   1.116</a>                  nextRowOffset = byteRaster.getScanlineStride();
<a id="l1.117" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.117">   1.117</a>                  offset = byteRaster.getDataOffset(0);
<a id="l1.118" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.118">   1.118</a>                  dataArray = byteRaster.getDataStorage();
<a id="l1.119" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.119">   1.119</a> +                dataArrayLength = byteRaster.getDataStorage().length;
<a id="l1.120" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.120">   1.120</a>                  dataType = DT_BYTE;
<a id="l1.121" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.121">   1.121</a>                  break;
<a id="l1.122" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.122">   1.122</a>  
<a id="l1.123" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.123">   1.123</a>              case BufferedImage.TYPE_USHORT_GRAY:
<a id="l1.124" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.124">   1.124</a>                  shortRaster = (ShortComponentRaster)image.getRaster();
<a id="l1.125" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.125">   1.125</a> -                nextRowOffset = shortRaster.getScanlineStride()*2;
<a id="l1.126" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.126">   1.126</a> -                offset = shortRaster.getDataOffset(0) * 2;
<a id="l1.127" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.127">   1.127</a> +                nextRowOffset = safeMult(2, shortRaster.getScanlineStride());
<a id="l1.128" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.128">   1.128</a> +                offset = safeMult(2, shortRaster.getDataOffset(0));
<a id="l1.129" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.129">   1.129</a>                  dataArray = shortRaster.getDataStorage();
<a id="l1.130" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.130">   1.130</a> +                dataArrayLength = 2 * shortRaster.getDataStorage().length;
<a id="l1.131" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.131">   1.131</a>                  dataType = DT_SHORT;
<a id="l1.132" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.132">   1.132</a>                  break;
<a id="l1.133" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.133">   1.133</a>          }
<a id="l1.134" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.134">   1.134</a> +        verify();
<a id="l1.135" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.135">   1.135</a>      }
<a id="l1.136" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.136">   1.136</a>  
<a id="l1.137" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.137">   1.137</a>      public static boolean isSupported(BufferedImage image) {
<a id="l1.138" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.138">   1.138</a> @@ -232,4 +266,45 @@
<a id="l1.139" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.139">   1.139</a>          }
<a id="l1.140" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.140">   1.140</a>          return false;
<a id="l1.141" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.141">   1.141</a>      }
<a id="l1.142" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.142">   1.142</a> +
<a id="l1.143" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.143">   1.143</a> +    private void verify() throws ImageLayoutException {
<a id="l1.144" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.144">   1.144</a> +
<a id="l1.145" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.145">   1.145</a> +        if (offset &lt; 0 || offset &gt;= dataArrayLength) {
<a id="l1.146" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.146">   1.146</a> +            throw new ImageLayoutException("Invalid image layout");
<a id="l1.147" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.147">   1.147</a> +        }
<a id="l1.148" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.148">   1.148</a> +
<a id="l1.149" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.149">   1.149</a> +        int lastPixelOffset = safeMult(nextRowOffset, (height - 1));
<a id="l1.150" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.150">   1.150</a> +
<a id="l1.151" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.151">   1.151</a> +        lastPixelOffset = safeAdd(lastPixelOffset, (width - 1));
<a id="l1.152" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.152">   1.152</a> +
<a id="l1.153" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.153">   1.153</a> +        int off = safeAdd(offset, lastPixelOffset);
<a id="l1.154" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.154">   1.154</a> +
<a id="l1.155" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.155">   1.155</a> +        if (off &lt; 0 || off &gt;= dataArrayLength) {
<a id="l1.156" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.156">   1.156</a> +            throw new ImageLayoutException("Invalid image layout");
<a id="l1.157" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.157">   1.157</a> +        }
<a id="l1.158" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.158">   1.158</a> +    }
<a id="l1.159" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.159">   1.159</a> +
<a id="l1.160" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.160">   1.160</a> +    static int safeAdd(int a, int b) throws ImageLayoutException {
<a id="l1.161" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.161">   1.161</a> +        long res = a;
<a id="l1.162" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.162">   1.162</a> +        res += b;
<a id="l1.163" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.163">   1.163</a> +        if (res &lt; Integer.MIN_VALUE || res &gt; Integer.MAX_VALUE) {
<a id="l1.164" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.164">   1.164</a> +            throw new ImageLayoutException("Invalid image layout");
<a id="l1.165" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.165">   1.165</a> +        }
<a id="l1.166" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.166">   1.166</a> +        return (int)res;
<a id="l1.167" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.167">   1.167</a> +    }
<a id="l1.168" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.168">   1.168</a> +
<a id="l1.169" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.169">   1.169</a> +    static int safeMult(int a, int b) throws ImageLayoutException {
<a id="l1.170" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.170">   1.170</a> +        long res = a;
<a id="l1.171" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.171">   1.171</a> +        res *= b;
<a id="l1.172" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.172">   1.172</a> +        if (res &lt; Integer.MIN_VALUE || res &gt; Integer.MAX_VALUE) {
<a id="l1.173" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.173">   1.173</a> +            throw new ImageLayoutException("Invalid image layout");
<a id="l1.174" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.174">   1.174</a> +        }
<a id="l1.175" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.175">   1.175</a> +        return (int)res;
<a id="l1.176" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.176">   1.176</a> +    }
<a id="l1.177" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.177">   1.177</a> +
<a id="l1.178" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.178">   1.178</a> +    public static class ImageLayoutException extends Exception {
<a id="l1.179" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.179">   1.179</a> +        public ImageLayoutException(String message) {
<a id="l1.180" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.180">   1.180</a> +            super(message);
<a id="l1.181" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.181">   1.181</a> +        }
<a id="l1.182" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.182">   1.182</a> +    }
<a id="l1.183" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l1.183">   1.183</a>  }</pre>
</div>
<div>
<pre><a id="l2.1" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.1">     2.1</a> --- a/src/share/classes/sun/java2d/cmm/lcms/LCMSTransform.java	Thu Feb 14 19:51:51 2013 +0400
<a id="l2.2" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.2">     2.2</a> +++ b/src/share/classes/sun/java2d/cmm/lcms/LCMSTransform.java	Thu Feb 21 11:25:43 2013 +0400
<a id="l2.3" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.3">     2.3</a> @@ -51,6 +51,7 @@
<a id="l2.4" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.4">     2.4</a>  import java.awt.image.ComponentSampleModel;
<a id="l2.5" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.5">     2.5</a>  import sun.java2d.cmm.*;
<a id="l2.6" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.6">     2.6</a>  import sun.java2d.cmm.lcms.*;
<a id="l2.7" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.7">     2.7</a> +import static sun.java2d.cmm.lcms.LCMSImageLayout.ImageLayoutException;
<a id="l2.8" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.8">     2.8</a>  
<a id="l2.9" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.9">     2.9</a>  
<a id="l2.10" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.10">    2.10</a>  public class LCMSTransform implements ColorTransform {
<a id="l2.11" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.11">    2.11</a> @@ -157,8 +158,12 @@
<a id="l2.12" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.12">    2.12</a>          if (LCMSImageLayout.isSupported(src) &amp;&amp;
<a id="l2.13" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.13">    2.13</a>              LCMSImageLayout.isSupported(dst))
<a id="l2.14" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.14">    2.14</a>          {
<a id="l2.15" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.15">    2.15</a> -            doTransform(new LCMSImageLayout(src), new LCMSImageLayout(dst));
<a id="l2.16" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.16">    2.16</a> -            return;
<a id="l2.17" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.17">    2.17</a> +            try {
<a id="l2.18" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.18">    2.18</a> +                doTransform(new LCMSImageLayout(src), new LCMSImageLayout(dst));
<a id="l2.19" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.19">    2.19</a> +                return;
<a id="l2.20" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.20">    2.20</a> +            } catch (ImageLayoutException e) {
<a id="l2.21" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.21">    2.21</a> +                throw new CMMException("Unable to convert images");
<a id="l2.22" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.22">    2.22</a> +            }
<a id="l2.23" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.23">    2.23</a>          }
<a id="l2.24" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.24">    2.24</a>          LCMSImageLayout srcIL, dstIL;
<a id="l2.25" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.25">    2.25</a>          Raster srcRas = src.getRaster();
<a id="l2.26" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.26">    2.26</a> @@ -216,14 +221,18 @@
<a id="l2.27" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.27">    2.27</a>              }
<a id="l2.28" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.28">    2.28</a>              int idx;
<a id="l2.29" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.29">    2.29</a>              // TODO check for src npixels = dst npixels
<a id="l2.30" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.30">    2.30</a> -            srcIL = new LCMSImageLayout(
<a id="l2.31" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.31">    2.31</a> -                srcLine, srcLine.length/getNumInComponents(),
<a id="l2.32" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.32">    2.32</a> -                LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.33" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.33">    2.33</a> -                LCMSImageLayout.BYTES_SH(1), getNumInComponents());
<a id="l2.34" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.34">    2.34</a> -            dstIL = new LCMSImageLayout(
<a id="l2.35" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.35">    2.35</a> -                dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.36" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.36">    2.36</a> -                LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.37" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.37">    2.37</a> -                LCMSImageLayout.BYTES_SH(1), getNumOutComponents());
<a id="l2.38" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.38">    2.38</a> +            try {
<a id="l2.39" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.39">    2.39</a> +                srcIL = new LCMSImageLayout(
<a id="l2.40" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.40">    2.40</a> +                        srcLine, srcLine.length/getNumInComponents(),
<a id="l2.41" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.41">    2.41</a> +                        LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.42" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.42">    2.42</a> +                        LCMSImageLayout.BYTES_SH(1), getNumInComponents());
<a id="l2.43" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.43">    2.43</a> +                dstIL = new LCMSImageLayout(
<a id="l2.44" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.44">    2.44</a> +                        dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.45" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.45">    2.45</a> +                        LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.46" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.46">    2.46</a> +                        LCMSImageLayout.BYTES_SH(1), getNumOutComponents());
<a id="l2.47" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.47">    2.47</a> +            } catch (ImageLayoutException e) {
<a id="l2.48" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.48">    2.48</a> +                throw new CMMException("Unable to convert images");
<a id="l2.49" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.49">    2.49</a> +            }
<a id="l2.50" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.50">    2.50</a>              // process each scanline
<a id="l2.51" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.51">    2.51</a>              for (int y = 0; y &lt; h; y++) {
<a id="l2.52" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.52">    2.52</a>                  // convert src scanline
<a id="l2.53" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.53">    2.53</a> @@ -272,16 +281,19 @@
<a id="l2.54" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.54">    2.54</a>                  alpha = new float[w];
<a id="l2.55" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.55">    2.55</a>              }
<a id="l2.56" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.56">    2.56</a>              int idx;
<a id="l2.57" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.57">    2.57</a> -            srcIL = new LCMSImageLayout(
<a id="l2.58" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.58">    2.58</a> -                srcLine, srcLine.length/getNumInComponents(),
<a id="l2.59" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.59">    2.59</a> -                LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.60" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.60">    2.60</a> -                LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.61" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.61">    2.61</a> +            try {
<a id="l2.62" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.62">    2.62</a> +                srcIL = new LCMSImageLayout(
<a id="l2.63" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.63">    2.63</a> +                    srcLine, srcLine.length/getNumInComponents(),
<a id="l2.64" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.64">    2.64</a> +                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.65" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.65">    2.65</a> +                    LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.66" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.66">    2.66</a>  
<a id="l2.67" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.67">    2.67</a> -            dstIL = new LCMSImageLayout(
<a id="l2.68" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.68">    2.68</a> -                dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.69" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.69">    2.69</a> -                LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.70" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.70">    2.70</a> -                LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.71" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.71">    2.71</a> -
<a id="l2.72" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.72">    2.72</a> +                dstIL = new LCMSImageLayout(
<a id="l2.73" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.73">    2.73</a> +                    dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.74" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.74">    2.74</a> +                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.75" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.75">    2.75</a> +                    LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.76" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.76">    2.76</a> +            } catch (ImageLayoutException e) {
<a id="l2.77" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.77">    2.77</a> +                throw new CMMException("Unable to convert images");
<a id="l2.78" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.78">    2.78</a> +            }
<a id="l2.79" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.79">    2.79</a>              // process each scanline
<a id="l2.80" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.80">    2.80</a>              for (int y = 0; y &lt; h; y++) {
<a id="l2.81" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.81">    2.81</a>                  // convert src scanline
<a id="l2.82" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.82">    2.82</a> @@ -390,16 +402,19 @@
<a id="l2.83" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.83">    2.83</a>          short[] srcLine = new short[w * srcNumBands];
<a id="l2.84" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.84">    2.84</a>          short[] dstLine = new short[w * dstNumBands];
<a id="l2.85" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.85">    2.85</a>          int idx;
<a id="l2.86" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.86">    2.86</a> -        srcIL = new LCMSImageLayout(
<a id="l2.87" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.87">    2.87</a> -            srcLine, srcLine.length/getNumInComponents(),
<a id="l2.88" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.88">    2.88</a> -            LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.89" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.89">    2.89</a> -            LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.90" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.90">    2.90</a> +        try {
<a id="l2.91" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.91">    2.91</a> +            srcIL = new LCMSImageLayout(
<a id="l2.92" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.92">    2.92</a> +                    srcLine, srcLine.length/getNumInComponents(),
<a id="l2.93" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.93">    2.93</a> +                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.94" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.94">    2.94</a> +                    LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.95" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.95">    2.95</a>  
<a id="l2.96" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.96">    2.96</a> -        dstIL = new LCMSImageLayout(
<a id="l2.97" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.97">    2.97</a> -            dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.98" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.98">    2.98</a> -            LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.99" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.99">    2.99</a> -            LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.100" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.100">   2.100</a> -
<a id="l2.101" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.101">   2.101</a> +            dstIL = new LCMSImageLayout(
<a id="l2.102" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.102">   2.102</a> +                    dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.103" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.103">   2.103</a> +                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.104" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.104">   2.104</a> +                    LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.105" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.105">   2.105</a> +        } catch (ImageLayoutException e) {
<a id="l2.106" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.106">   2.106</a> +            throw new CMMException("Unable to convert rasters");
<a id="l2.107" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.107">   2.107</a> +        }
<a id="l2.108" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.108">   2.108</a>          // process each scanline
<a id="l2.109" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.109">   2.109</a>          for (int y = 0; y &lt; h; y++, ys++, yd++) {
<a id="l2.110" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.110">   2.110</a>              // get src scanline
<a id="l2.111" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.111">   2.111</a> @@ -482,15 +497,18 @@
<a id="l2.112" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.112">   2.112</a>              byte[] dstLine = new byte[w * dstNumBands];
<a id="l2.113" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.113">   2.113</a>              int idx;
<a id="l2.114" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.114">   2.114</a>              // TODO check for src npixels = dst npixels
<a id="l2.115" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.115">   2.115</a> -            srcIL = new LCMSImageLayout(
<a id="l2.116" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.116">   2.116</a> -                srcLine, srcLine.length/getNumInComponents(),
<a id="l2.117" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.117">   2.117</a> -                LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.118" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.118">   2.118</a> -                LCMSImageLayout.BYTES_SH(1), getNumInComponents());
<a id="l2.119" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.119">   2.119</a> -            dstIL = new LCMSImageLayout(
<a id="l2.120" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.120">   2.120</a> -                dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.121" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.121">   2.121</a> -                LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.122" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.122">   2.122</a> -                LCMSImageLayout.BYTES_SH(1), getNumOutComponents());
<a id="l2.123" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.123">   2.123</a> -
<a id="l2.124" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.124">   2.124</a> +            try {
<a id="l2.125" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.125">   2.125</a> +                srcIL = new LCMSImageLayout(
<a id="l2.126" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.126">   2.126</a> +                        srcLine, srcLine.length/getNumInComponents(),
<a id="l2.127" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.127">   2.127</a> +                        LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.128" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.128">   2.128</a> +                        LCMSImageLayout.BYTES_SH(1), getNumInComponents());
<a id="l2.129" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.129">   2.129</a> +                dstIL = new LCMSImageLayout(
<a id="l2.130" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.130">   2.130</a> +                        dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.131" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.131">   2.131</a> +                        LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.132" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.132">   2.132</a> +                        LCMSImageLayout.BYTES_SH(1), getNumOutComponents());
<a id="l2.133" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.133">   2.133</a> +            } catch (ImageLayoutException e) {
<a id="l2.134" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.134">   2.134</a> +                throw new CMMException("Unable to convert rasters");
<a id="l2.135" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.135">   2.135</a> +            }
<a id="l2.136" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.136">   2.136</a>              // process each scanline
<a id="l2.137" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.137">   2.137</a>              for (int y = 0; y &lt; h; y++, ys++, yd++) {
<a id="l2.138" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.138">   2.138</a>                  // get src scanline
<a id="l2.139" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.139">   2.139</a> @@ -522,16 +540,20 @@
<a id="l2.140" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.140">   2.140</a>              short[] srcLine = new short[w * srcNumBands];
<a id="l2.141" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.141">   2.141</a>              short[] dstLine = new short[w * dstNumBands];
<a id="l2.142" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.142">   2.142</a>              int idx;
<a id="l2.143" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.143">   2.143</a> -            srcIL = new LCMSImageLayout(
<a id="l2.144" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.144">   2.144</a> -                srcLine, srcLine.length/getNumInComponents(),
<a id="l2.145" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.145">   2.145</a> -                LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.146" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.146">   2.146</a> -                LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.147" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.147">   2.147</a>  
<a id="l2.148" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.148">   2.148</a> -            dstIL = new LCMSImageLayout(
<a id="l2.149" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.149">   2.149</a> -                dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.150" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.150">   2.150</a> -                LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.151" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.151">   2.151</a> -                LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.152" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.152">   2.152</a> +            try {
<a id="l2.153" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.153">   2.153</a> +                srcIL = new LCMSImageLayout(
<a id="l2.154" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.154">   2.154</a> +                        srcLine, srcLine.length/getNumInComponents(),
<a id="l2.155" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.155">   2.155</a> +                        LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.156" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.156">   2.156</a> +                        LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.157" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.157">   2.157</a>  
<a id="l2.158" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.158">   2.158</a> +                dstIL = new LCMSImageLayout(
<a id="l2.159" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.159">   2.159</a> +                        dstLine, dstLine.length/getNumOutComponents(),
<a id="l2.160" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.160">   2.160</a> +                        LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.161" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.161">   2.161</a> +                        LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.162" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.162">   2.162</a> +            } catch (ImageLayoutException e) {
<a id="l2.163" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.163">   2.163</a> +                throw new CMMException("Unable to convert rasters");
<a id="l2.164" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.164">   2.164</a> +            }
<a id="l2.165" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.165">   2.165</a>              // process each scanline
<a id="l2.166" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.166">   2.166</a>              for (int y = 0; y &lt; h; y++, ys++, yd++) {
<a id="l2.167" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.167">   2.167</a>                  // get src scanline
<a id="l2.168" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.168">   2.168</a> @@ -572,19 +594,23 @@
<a id="l2.169" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.169">   2.169</a>              dst = new short [(src.length/getNumInComponents())*getNumOutComponents()];
<a id="l2.170" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.170">   2.170</a>          }
<a id="l2.171" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.171">   2.171</a>  
<a id="l2.172" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.172">   2.172</a> -        LCMSImageLayout srcIL = new LCMSImageLayout(
<a id="l2.173" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.173">   2.173</a> -            src, src.length/getNumInComponents(),
<a id="l2.174" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.174">   2.174</a> -            LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.175" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.175">   2.175</a> -            LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.176" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.176">   2.176</a> +        try {
<a id="l2.177" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.177">   2.177</a> +            LCMSImageLayout srcIL = new LCMSImageLayout(
<a id="l2.178" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.178">   2.178</a> +                    src, src.length/getNumInComponents(),
<a id="l2.179" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.179">   2.179</a> +                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.180" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.180">   2.180</a> +                    LCMSImageLayout.BYTES_SH(2), getNumInComponents()*2);
<a id="l2.181" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.181">   2.181</a>  
<a id="l2.182" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.182">   2.182</a> -        LCMSImageLayout dstIL = new LCMSImageLayout(
<a id="l2.183" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.183">   2.183</a> -            dst, dst.length/getNumOutComponents(),
<a id="l2.184" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.184">   2.184</a> -            LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.185" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.185">   2.185</a> -            LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.186" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.186">   2.186</a> +            LCMSImageLayout dstIL = new LCMSImageLayout(
<a id="l2.187" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.187">   2.187</a> +                    dst, dst.length/getNumOutComponents(),
<a id="l2.188" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.188">   2.188</a> +                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.189" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.189">   2.189</a> +                    LCMSImageLayout.BYTES_SH(2), getNumOutComponents()*2);
<a id="l2.190" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.190">   2.190</a>  
<a id="l2.191" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.191">   2.191</a> -        doTransform(srcIL, dstIL);
<a id="l2.192" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.192">   2.192</a> +            doTransform(srcIL, dstIL);
<a id="l2.193" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.193">   2.193</a>  
<a id="l2.194" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.194">   2.194</a> -        return dst;
<a id="l2.195" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.195">   2.195</a> +            return dst;
<a id="l2.196" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.196">   2.196</a> +        } catch (ImageLayoutException e) {
<a id="l2.197" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.197">   2.197</a> +            throw new CMMException("Unable to convert data");
<a id="l2.198" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.198">   2.198</a> +        }
<a id="l2.199" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.199">   2.199</a>      }
<a id="l2.200" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.200">   2.200</a>  
<a id="l2.201" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.201">   2.201</a>      public byte[] colorConvert(byte[] src, byte[] dst) {
<a id="l2.202" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.202">   2.202</a> @@ -592,18 +618,22 @@
<a id="l2.203" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.203">   2.203</a>              dst = new byte [(src.length/getNumInComponents())*getNumOutComponents()];
<a id="l2.204" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.204">   2.204</a>          }
<a id="l2.205" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.205">   2.205</a>  
<a id="l2.206" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.206">   2.206</a> -        LCMSImageLayout srcIL = new LCMSImageLayout(
<a id="l2.207" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.207">   2.207</a> -            src, src.length/getNumInComponents(),
<a id="l2.208" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.208">   2.208</a> -            LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.209" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.209">   2.209</a> -            LCMSImageLayout.BYTES_SH(1), getNumInComponents());
<a id="l2.210" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.210">   2.210</a> +        try {
<a id="l2.211" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.211">   2.211</a> +            LCMSImageLayout srcIL = new LCMSImageLayout(
<a id="l2.212" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.212">   2.212</a> +                    src, src.length/getNumInComponents(),
<a id="l2.213" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.213">   2.213</a> +                    LCMSImageLayout.CHANNELS_SH(getNumInComponents()) |
<a id="l2.214" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.214">   2.214</a> +                    LCMSImageLayout.BYTES_SH(1), getNumInComponents());
<a id="l2.215" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.215">   2.215</a>  
<a id="l2.216" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.216">   2.216</a> -        LCMSImageLayout dstIL = new LCMSImageLayout(
<a id="l2.217" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.217">   2.217</a> -            dst, dst.length/getNumOutComponents(),
<a id="l2.218" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.218">   2.218</a> -            LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.219" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.219">   2.219</a> -            LCMSImageLayout.BYTES_SH(1), getNumOutComponents());
<a id="l2.220" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.220">   2.220</a> +            LCMSImageLayout dstIL = new LCMSImageLayout(
<a id="l2.221" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.221">   2.221</a> +                    dst, dst.length/getNumOutComponents(),
<a id="l2.222" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.222">   2.222</a> +                    LCMSImageLayout.CHANNELS_SH(getNumOutComponents()) |
<a id="l2.223" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.223">   2.223</a> +                    LCMSImageLayout.BYTES_SH(1), getNumOutComponents());
<a id="l2.224" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.224">   2.224</a>  
<a id="l2.225" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.225">   2.225</a> -        doTransform(srcIL, dstIL);
<a id="l2.226" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.226">   2.226</a> +            doTransform(srcIL, dstIL);
<a id="l2.227" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.227">   2.227</a>  
<a id="l2.228" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.228">   2.228</a> -        return dst;
<a id="l2.229" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.229">   2.229</a> +            return dst;
<a id="l2.230" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.230">   2.230</a> +        } catch (ImageLayoutException e) {
<a id="l2.231" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.231">   2.231</a> +            throw new CMMException("Unable to convert data");
<a id="l2.232" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.232">   2.232</a> +        }
<a id="l2.233" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.233">   2.233</a>      }
<a id="l2.234" href="http://icedtea.classpath.org/hg/release/icedtea7-forest-2.3/jdk/rev/4f97a6256473#l2.234">   2.234</a>  }

thanks,
Hardik</pre>
</div>
<!-- CONTENT_END -->
        </article>

        <!-- Tags & Share -->
        <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm font-semibold text-gray-500 dark:text-gray-400 mr-2">Tags:</span>
                    <!-- TAGS_START -->

<!-- TAGS_END -->
                </div>
            </div>
        </div>

        <!-- Post Navigation -->
        <!-- POST_NAVIGATION_START -->
<div class="flex flex-col md:flex-row justify-between items-center border-t border-gray-200 dark:border-gray-700 pt-6 mt-8 gap-4"><div class="w-full md:w-1/2"></div>
                <a href="cve-2012-0003-analysis.html" class="flex items-center justify-end text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition group text-right w-full md:w-1/2">
                    <div>
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 block mb-1">Next</span>
                        <span class="font-semibold line-clamp-1">CVE-2012-0003 Analysis</span>
                    </div>
                    <i class="fas fa-arrow-right ml-3 group-hover:translate-x-1 transition-transform"></i>
                </a>
                </div>
<!-- POST_NAVIGATION_END -->

        <!-- Related Posts -->
        <div class="mt-16 border-t border-gray-200 dark:border-gray-700 pt-10">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Related Posts</h3>
            <div id="relatedPosts" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Populated by JS -->
            </div>
        </div>

    </main>

    <footer class="bg-gray-100 dark:bg-gray-900 p-8 text-center border-t border-gray-200 dark:border-gray-800 mt-12 transition-colors duration-300"></footer>

    <script src="posts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentTitle = document.querySelector('h1').innerText.trim();
            const relatedContainer = document.getElementById('relatedPosts');
            
            if (!window.blogPosts || !relatedContainer) return;

            // Get current category
            const categoryEl = document.querySelector('header span.uppercase');
            const currentCategory = categoryEl ? categoryEl.innerText.trim() : '';

            // Filter posts
            let related = window.blogPosts.filter(post => 
                post.title !== currentTitle && 
                post.category === currentCategory
            );

            // Fallback to recent if not enough related
            if (related.length < 3) {
                const recent = window.blogPosts.filter(post => post.title !== currentTitle && !related.includes(post));
                related = related.concat(recent).slice(0, 3);
            } else {
                related = related.slice(0, 3);
            }

            relatedContainer.innerHTML = related.map(post => {
                // Fix link for relative path (remove 'blog/' prefix)
                const relativeLink = post.link.replace(/^blog\//, '');
                
                return `
                <a href="${relativeLink}" class="block group">
                    ${post.image ? `<div class="h-40 mb-4 overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800"><img src="${post.image}" alt="${post.title}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300"></div>` : '<div class="h-40 mb-4 overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-400"><i class="fas fa-newspaper text-3xl"></i></div>'}
                    <h4 class="font-bold text-gray-900 dark:text-white group-hover:text-blue-400 transition line-clamp-2">${post.title}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${post.date}</p>
                </a>
            `}).join('');
        });

        // Table of Contents Generator
        document.addEventListener('DOMContentLoaded', () => {
            const article = document.querySelector('article');
            const tocContainer = document.getElementById('toc');
            const tocList = document.getElementById('toc-list');
            
            if (!article || !tocContainer || !tocList) return;

            const headings = article.querySelectorAll('h2, h3');
            
            if (headings.length < 2) {
                return; 
            }

            tocContainer.classList.remove('hidden');

            headings.forEach((heading, index) => {
                if (!heading.id) {
                    heading.id = `heading-${index}`;
                }

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${heading.id}`;
                a.textContent = heading.innerText;
                a.className = heading.tagName === 'H3' ? 'ml-4 hover:text-blue-500 transition' : 'font-semibold hover:text-blue-500 transition';
                
                li.appendChild(a);
                tocList.appendChild(li);
            });
        });

        // Share Buttons Logic
        document.addEventListener('DOMContentLoaded', () => {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?text=${title}&url=${url}`;
            document.getElementById('share-linkedin').href = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            document.getElementById('share-email').href = `mailto:?subject=${title}&body=Check out this article: ${url}`;
            
            document.getElementById('copy-link-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    const icon = document.querySelector('#copy-link-btn i');
                    icon.className = 'fas fa-check text-emerald-500';
                    setTimeout(() => {
                        icon.className = 'fas fa-link';
                    }, 2000);
                });
            });
        });
    </script>
</body>
</html>