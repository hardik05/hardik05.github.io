<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Flow Guard - win10_64bit | Fuzzing.in</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-82JZEHCFPE"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-82JZEHCFPE');
    </script>
    <meta name="description" content="I downloaded sample programs from https://blog.trailofbits.com/2016/12/27/lets-talk-about-cfi-microsoft-edition/ and decided to see using windbg. following are ...">
    <meta name="keywords" content="">
    <meta name="author" content="Hardik Shah">
    <link rel="canonical" href="https://fuzzing.in/blog/control-flow-guard-win1064bit.html">
    
    <!-- Open Graph -->
    <meta property="og:type" content="article">
    <meta property="og:title" content="Control Flow Guard - win10_64bit | Fuzzing.in">
    <meta property="og:description" content="I downloaded sample programs from https://blog.trailofbits.com/2016/12/27/lets-talk-about-cfi-microsoft-edition/ and decided to see using windbg. following are ...">
    <meta property="og:image" content="https://hardik05.wordpress.com/wp-content/uploads/2017/01/ntdll_1.png">
    <meta property="og:url" content="https://fuzzing.in/blog/control-flow-guard-win1064bit.html">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:title" content="Control Flow Guard - win10_64bit | Fuzzing.in">
    <meta property="twitter:description" content="I downloaded sample programs from https://blog.trailofbits.com/2016/12/27/lets-talk-about-cfi-microsoft-edition/ and decided to see using windbg. following are ...">
    <meta property="twitter:image" content="https://hardik05.wordpress.com/wp-content/uploads/2017/01/ntdll_1.png">

    <link rel="icon" href="../images/logo.jpg" type="image/jpeg">
    
    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script>
        tailwind.config = { 
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        };
    </script>
    <script src="../js/nav.js" defer></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for code blocks */
        pre::-webkit-scrollbar { height: 8px; }
        pre::-webkit-scrollbar-track { background: #374151; border-radius: 4px; }
        pre::-webkit-scrollbar-thumb { background: #6b7280; border-radius: 4px; }
    </style>
</head>
<body class="py-4 md:py-10 px-2 bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Header (Paths adjusted with ../ for subdirectory) -->
    <header class="sticky top-0 z-50 bg-white/95 dark:bg-gray-900/95 backdrop-blur-sm border-b border-gray-200 dark:border-gray-800 transition-colors duration-300">
        <div class="container mx-auto flex justify-between items-center p-4 md:p-6">
            <a href="../index.html" class="flex items-center gap-3 text-3xl font-extrabold text-blue-500 tracking-widest">
                <img src="../images/logo.jpg" alt="Fuzzing.in Logo" class="h-10 w-10 rounded-full object-cover border-2 border-blue-500">
                FUZZING.IN
            </a>
            <nav class="hidden md:flex space-x-6 text-sm font-medium">
                <a href="../index.html" class="hover:text-blue-400 transition">Home</a>
                <a href="../trainings.html" class="hover:text-blue-400 transition">Trainings</a>
                <a href="../blog.html" class="hover:text-blue-400 transition text-blue-400 font-bold">Blog</a>
                <a href="../advisories.html" class="hover:text-blue-400 transition">Advisories</a>
                <a href="../patents.html" class="hover:text-blue-400 transition">Patents</a>
                <a href="../publications.html" class="hover:text-blue-400 transition">Publications</a>
                <a href="../media.html" class="hover:text-blue-400 transition">Media</a>
                <a href="../about.html" class="hover:text-blue-400 transition">About</a>
                <a href="../contact.html" class="hover:text-blue-400 transition">Contact</a>
                <a href="../contact.html" class="px-3 py-1 bg-emerald-600 text-white rounded-full hover:bg-emerald-500 transition shadow-md">Private Training</a>
                <button id="theme-toggle" class="text-gray-500 dark:text-gray-300 hover:text-blue-400 transition ml-4">
                    <i class="fas fa-moon theme-toggle-icon"></i>
                </button>
            </nav>
            <button class="md:hidden text-2xl text-gray-900 dark:text-white"><i class="fas fa-bars"></i></button>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <!-- Breadcrumb / Back Link -->
        <div class="mb-8">
            <a href="../blog.html" class="text-blue-500 hover:text-blue-400 font-semibold flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back to Blog
            </a>
        </div>

        <!-- Article Header -->
        <header class="mb-10 text-center md:text-left">
            <span class="inline-block px-3 py-1 bg-pink-100 dark:bg-pink-900/30 text-pink-600 dark:text-pink-400 rounded-full text-xs font-bold uppercase tracking-widest mb-4">
                Uncategorized
            </span>
            <h1 class="text-3xl md:text-5xl font-extrabold text-gray-900 dark:text-white mb-6 leading-tight">
                Control Flow Guard - win10_64bit
            </h1>
            <div class="flex flex-wrap items-center gap-6 text-gray-500 dark:text-gray-400 text-sm">
                <div class="flex items-center gap-2">
                    <img src="../images/hardik.webp" alt="Author" class="w-8 h-8 rounded-full border border-gray-300 dark:border-gray-600 object-cover">
                    <span class="font-medium text-gray-900 dark:text-gray-200">Hardik Shah</span>
                </div>
                <span class="hidden md:inline">•</span>
                <div class="flex items-center gap-2">
                    <i class="far fa-calendar-alt"></i>
                    <span>January 16, 2017</span>
                </div>
                <span class="hidden md:inline">•</span>
                <div class="flex items-center gap-2">
                    <i class="far fa-clock"></i>
                    <span>4 min read</span>
                </div>
                
                <!-- Share Buttons -->
                <div class="flex items-center gap-3 md:ml-auto">
                    <a href="#" id="share-twitter" target="_blank" class="text-gray-500 hover:text-blue-400 transition text-lg" title="Share on Twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" id="share-linkedin" target="_blank" class="text-gray-500 hover:text-blue-700 transition text-lg" title="Share on LinkedIn">
                        <i class="fab fa-linkedin"></i>
                    </a>
                    <a href="#" id="share-facebook" target="_blank" class="text-gray-500 hover:text-blue-600 transition text-lg" title="Share on Facebook">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="#" id="share-email" class="text-gray-500 hover:text-red-500 transition text-lg" title="Share via Email">
                        <i class="fas fa-envelope"></i>
                    </a>
                    <button id="copy-link-btn" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition text-lg" title="Copy Link">
                        <i class="fas fa-link"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Featured Image (Optional) -->
        <div class="mb-10 rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700">
            <!-- FEATURED_IMAGE_START -->
<img src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/ntdll_1.png" alt="Control Flow Guard - win10_64bit" class="w-full h-full object-cover">
<!-- FEATURED_IMAGE_END -->
        </div>

        <!-- Table of Contents -->
        <div id="toc" class="hidden mb-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">Table of Contents</h3>
            <nav>
                <ul id="toc-list" class="space-y-2 text-sm text-gray-600 dark:text-gray-300"></ul>
            </nav>
        </div>

        <!-- Article Content -->
        <!-- 'prose' class activates Tailwind Typography plugin -->
        <article class="prose prose-lg prose-slate dark:prose-invert max-w-none">
            <!-- CONTENT_START -->
I downloaded sample programs from https://blog.trailofbits.com/2016/12/27/lets-talk-about-cfi-microsoft-edition/ and decided to see using windbg. following are my observations with file cfg_guard_ignore.exe which you get on compilinh cfg_guard_ignore.cpp file.
<ol>
	<li>On load ntdll_address!<a href="http://forum.easeus.com/viewtopic.php?t=34976"> LDRSystemDLLInitBlock</a> has following strucutre:</li>
</ol>
<img class="alignnone size-full wp-image-311" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/ntdll_1.png" alt="ntdll_1" width="709" height="393" />

<a href="http://forum.easeus.com/viewtopic.php?t=34976"> LDRSystemDLLInitBlock</a>+60 will have address of cfg bitmap and <a href="http://forum.easeus.com/viewtopic.php?t=34976"> LDRSystemDLLInitBlock</a>+68 will have size of it.

2.following is the memory:

<img class="alignnone size-full wp-image-318" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/ntdll_2.png" alt="ntdll_2" width="848" height="250" />

3. more on memory:

<img class="alignnone size-full wp-image-321" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/cfg_entry.png" alt="cfg_entry" width="503" height="262" />

doing x cfg_guard_ignore!safe_calls gives the address of the function which is 0x013d2ac0 as shown in the above picture and then remove last 2 bytes will give 0x013d2a

on multiplying 0x013d2a by 4 and adding it to base address of cfg bitmap address will give 00000004 which is the entry in the bitmap. on calling this function or the address inside this function,a  value will be calculated and if it doesnot equal to 4 then call will be aborted otherwise execution will be continued as normal.

&nbsp;

now if we run the exe, there are two arguments 0 or 1. if we pass 1 then cfg check will not be enforced but if call 0 then cfg will come in to the picture. following are some live debugging screenshots with argument 0:
<ol>
	<li><img class="alignnone size-full wp-image-331" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/cfg_load_config.png" alt="cfg_load_config" width="937" height="385" />cfg_guard_ignore!_load_config_used+48 will give details on the function pointer which is used to call validate function which calculates the above mentioned value and then it will be compared with the bitmap.</li>
	<li>cfg_guard_ignore!__guard_fids_table will be having all the valid address offset. as shown in above pic.</li>
	<li>below is where guard_check_icall_ptr is called, which has address of Ldrpvalidateusercalltarget api:</li>
	<li><img class="alignnone size-full wp-image-338" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/call_validateusercalltarget.png" alt="call_validateusercalltarget" width="1920" height="1080" /></li>
</ol>
5.following is when we step in to the api:

<img class="alignnone size-full wp-image-335" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/call_inside.png" alt="call_inside" width="1920" height="1080" />

&nbsp;

following is how the value is calculated:

<img class="alignnone size-full wp-image-344" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/screenshot_4.png" alt="screenshot_4" width="962" height="106" />

<img class="alignnone size-full wp-image-346" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/screenshot_5.png" alt="screenshot_5" width="1305" height="416" />

if bt result is 0 then control jumps and we get int 29h:

<img class="alignnone size-full wp-image-350" src="https://hardik05.wordpress.com/wp-content/uploads/2017/01/screenshot_7.png" alt="screenshot_7" width="748" height="135" />

i will try to write detailed blog on the algorithm used to calculate the value and how it searches in the bitmap.

&nbsp;

this is a quick post and so might have certain errors.
<!-- CONTENT_END -->
        </article>

        <!-- Tags & Share -->
        <div class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex flex-wrap gap-2">
                    <span class="text-sm font-semibold text-gray-500 dark:text-gray-400 mr-2">Tags:</span>
                    <!-- TAGS_START -->

<!-- TAGS_END -->
                </div>
            </div>
        </div>

        <!-- Post Navigation -->
        <!-- POST_NAVIGATION_START -->
<div class="flex flex-col md:flex-row justify-between items-center border-t border-gray-200 dark:border-gray-700 pt-6 mt-8 gap-4">
                <a href="compiling-and-testing-openssl.html" class="flex items-center text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition group text-left w-full md:w-1/2">
                    <i class="fas fa-arrow-left mr-3 group-hover:-translate-x-1 transition-transform"></i>
                    <div>
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 block mb-1">Previous</span>
                        <span class="font-semibold line-clamp-1">compiling and testing openssl</span>
                    </div>
                </a>
                
                <a href="running-vlc-in-debug-mode.html" class="flex items-center justify-end text-gray-600 dark:text-gray-400 hover:text-blue-500 dark:hover:text-blue-400 transition group text-right w-full md:w-1/2">
                    <div>
                        <span class="text-xs font-bold uppercase tracking-wider text-gray-500 block mb-1">Next</span>
                        <span class="font-semibold line-clamp-1">running vlc in debug mode</span>
                    </div>
                    <i class="fas fa-arrow-right ml-3 group-hover:translate-x-1 transition-transform"></i>
                </a>
                </div>
<!-- POST_NAVIGATION_END -->

        <!-- Related Posts -->
        <div class="mt-16 border-t border-gray-200 dark:border-gray-700 pt-10">
            <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Related Posts</h3>
            <div id="relatedPosts" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Populated by JS -->
            </div>
        </div>

    </main>

    <footer class="bg-gray-100 dark:bg-gray-900 p-8 text-center border-t border-gray-200 dark:border-gray-800 mt-12 transition-colors duration-300">
        <p class="text-gray-500 font-medium text-lg">
            "Fuzzing is not magic; it's persistent, structured execution."
        </p>
        <div class="mt-4 flex justify-center space-x-6 text-2xl">
            <a href="https://twitter.com/hardik05" target="_blank" class="text-gray-500 hover:text-blue-400 transition"><i class="fab fa-twitter"></i></a>
            <a href="https://www.linkedin.com/in/hardik05" target="_blank" class="text-gray-500 hover:text-blue-400 transition"><i class="fab fa-linkedin-in"></i></a>
            <a href="#" class="text-gray-500 hover:text-blue-400 transition"><i class="fab fa-youtube"></i></a>
            <a href="https://github.com/hardik05" target="_blank" class="text-gray-500 hover:text-blue-400 transition"><i class="fab fa-github"></i></a>
        </div>
        <div class="mt-6 text-gray-600 text-xs space-x-4">
            <span>&copy; <span id="current-year">2024</span> Fuzzing.in</span>
            <span id="last-updated"></span>
            <a href="#" class="hover:text-gray-400">Terms</a>
            <a href="#" class="hover:text-gray-400">Privacy</a>
        </div>
    </footer>

    <script src="posts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentTitle = document.querySelector('h1').innerText.trim();
            const relatedContainer = document.getElementById('relatedPosts');
            
            if (!window.blogPosts || !relatedContainer) return;

            // Get current category
            const categoryEl = document.querySelector('header span.uppercase');
            const currentCategory = categoryEl ? categoryEl.innerText.trim() : '';

            // Filter posts
            let related = window.blogPosts.filter(post => 
                post.title !== currentTitle && 
                post.category === currentCategory
            );

            // Fallback to recent if not enough related
            if (related.length < 3) {
                const recent = window.blogPosts.filter(post => post.title !== currentTitle && !related.includes(post));
                related = related.concat(recent).slice(0, 3);
            } else {
                related = related.slice(0, 3);
            }

            relatedContainer.innerHTML = related.map(post => {
                // Fix link for relative path (remove 'blog/' prefix)
                const relativeLink = post.link.replace(/^blog\//, '');
                
                return `
                <a href="${relativeLink}" class="block group">
                    ${post.image ? `<div class="h-40 mb-4 overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800"><img src="${post.image}" alt="${post.title}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300"></div>` : '<div class="h-40 mb-4 overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-400"><i class="fas fa-newspaper text-3xl"></i></div>'}
                    <h4 class="font-bold text-gray-900 dark:text-white group-hover:text-blue-400 transition line-clamp-2">${post.title}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">${post.date}</p>
                </a>
            `}).join('');
        });

        // Table of Contents Generator
        document.addEventListener('DOMContentLoaded', () => {
            const article = document.querySelector('article');
            const tocContainer = document.getElementById('toc');
            const tocList = document.getElementById('toc-list');
            
            if (!article || !tocContainer || !tocList) return;

            const headings = article.querySelectorAll('h2, h3');
            
            if (headings.length < 2) {
                return; 
            }

            tocContainer.classList.remove('hidden');

            headings.forEach((heading, index) => {
                if (!heading.id) {
                    heading.id = `heading-${index}`;
                }

                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = `#${heading.id}`;
                a.textContent = heading.innerText;
                a.className = heading.tagName === 'H3' ? 'ml-4 hover:text-blue-500 transition' : 'font-semibold hover:text-blue-500 transition';
                
                li.appendChild(a);
                tocList.appendChild(li);
            });
        });

        // Share Buttons Logic
        document.addEventListener('DOMContentLoaded', () => {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(document.title);
            
            document.getElementById('share-twitter').href = `https://twitter.com/intent/tweet?text=${title}&url=${url}`;
            document.getElementById('share-linkedin').href = `https://www.linkedin.com/sharing/share-offsite/?url=${url}`;
            document.getElementById('share-facebook').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
            document.getElementById('share-email').href = `mailto:?subject=${title}&body=Check out this article: ${url}`;
            
            document.getElementById('copy-link-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href).then(() => {
                    const icon = document.querySelector('#copy-link-btn i');
                    icon.className = 'fas fa-check text-emerald-500';
                    setTimeout(() => {
                        icon.className = 'fas fa-link';
                    }, 2000);
                });
            });
        });
    </script>
</body>
</html>